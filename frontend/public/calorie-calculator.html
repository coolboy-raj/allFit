<!-- File: frontend/public/calorie-calculator.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TotalFit - Calorie Calculator</title>
    <!-- Bootstrap 5.3 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Luxon for Dates/Times -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>

    <style>
        body {
            background-color: #f0f2f5;
        }
        .progress-bar-container {
            position: relative;
            height: 30px;
            background-color: #e9ecef;
            border-radius: .25rem;
            overflow: hidden;
        }
        .progress-bar-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            color: #212529;
            z-index: 2;
        }
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1060; /* Higher than Bootstrap modal */
            display: none;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>

    <header class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/dashboard"><i class="fas fa-bolt text-primary"></i> TotalFit</a>
            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>
    </header>

    <main class="container my-4">
        <div class="row g-4">
            <!-- Left Column: Logger -->
            <div class="col-lg-7">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h2 class="card-title mb-4">Log a Meal</h2>
                        <div id="logging-wizard">
                            <!-- Step 1: Upload -->
                            <div id="step-upload">
                                <div class="mb-3">
                                    <label for="mealType" class="form-label">Meal Type</label>
                                    <select class="form-select" id="mealType">
                                        <option value="Breakfast">Breakfast</option>
                                        <option value="Lunch">Lunch</option>
                                        <option value="Dinner">Dinner</option>
                                        <option value="Snack">Snack</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="imageUpload" class="form-label">Upload a photo of your food</label>
                                    <input class="form-control" type="file" id="imageUpload" accept="image/*">
                                </div>
                                <img id="imagePreview" src="" class="img-fluid rounded mb-3" style="display:none; max-height: 300px;" alt="Image Preview">
                                <button id="analyzeBtn" class="btn btn-primary w-100" disabled><i class="fas fa-search"></i> Analyze Image</button>
                            </div>

                            <!-- Step 2: Results -->
                            <div id="step-results" style="display:none;">
                                <h4 class="mb-3">Analysis Results</h4>
                                <div id="analysis-results-table"></div>
                                <div class="d-flex justify-content-between mt-3">
                                     <button id="logMealBtn" class="btn btn-success"><i class="fas fa-plus"></i> Log Meal</button>
                                     <button id="startOverBtn" class="btn btn-secondary">Start Over</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Dashboard & Suggestions -->
            <div class="col-lg-5">
                <!-- Daily Progress -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h4 class="card-title">Today's Progress</h4>
                        <div id="progress-text" class="text-center fs-5 mb-2"></div>
                        <div class="progress-bar-container">
                            <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                             <div id="progress-bar-text" class="progress-bar-text"></div>
                        </div>
                    </div>
                </div>

                <!-- Logged Meals -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h4 class="card-title">Logged Meals</h4>
                        <div id="logged-meals-list" class="accordion"></div>
                    </div>
                </div>

                 <!-- Suggestions -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h4 class="card-title">Meal Suggestions</h4>
                        <div id="suggestions-container" class="mt-3">
                           <p class="text-muted">Log a meal to get suggestions.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="calorieTarget" class="form-label">Daily Calorie Target (kcal)</label>
                        <input type="number" class="form-control" id="calorieTarget" value="2000">
                    </div>
                    <h6>Meal Times (24-hour format)</h6>
                    <div class="row g-2 mb-2">
                        <div class="col-3"><label class="col-form-label">Breakfast</label></div>
                        <div class="col"><input type="time" id="breakfastStart" class="form-control"></div>
                        <div class="col"><input type="time" id="breakfastEnd" class="form-control"></div>
                    </div>
                     <div class="row g-2 mb-2">
                        <div class="col-3"><label class="col-form-label">Lunch</label></div>
                        <div class="col"><input type="time" id="lunchStart" class="form-control"></div>
                        <div class="col"><input type="time" id="lunchEnd" class="form-control"></div>
                    </div>
                     <div class="row g-2">
                        <div class="col-3"><label class="col-form-label">Dinner</label></div>
                        <div class="col"><input type="time" id="dinnerStart" class="form-control"></div>
                        <div class="col"><input type="time" id="dinnerEnd" class="form-control"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="saveSettingsBtn" class="btn btn-primary">Save Settings</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Spinner Overlay -->
    <div id="spinner-overlay" class="spinner-overlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Alert Placeholder -->
    <div id="alert-placeholder" class="position-fixed top-0 end-0 p-3" style="z-index: 1100"></div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Embedded Application Logic -->
    <script>
        // --- CONFIGURATION ---
        // URLs point to the local proxy server (backend/proxy-server.js)
        const PROXY_BASE_URL = 'http://localhost:3001/api';

        // --- DOM ELEMENTS ---
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const mealTypeSelect = document.getElementById('mealType');
        const stepUpload = document.getElementById('step-upload');
        const stepResults = document.getElementById('step-results');
        const analysisResultsTableContainer = document.getElementById('analysis-results-table');
        const logMealBtn = document.getElementById('logMealBtn');
        const startOverBtn = document.getElementById('startOverBtn');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const progressBarText = document.getElementById('progress-bar-text');
        const loggedMealsList = document.getElementById('logged-meals-list');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const settingsModalEl = document.getElementById('settingsModal');
        const calorieTargetInput = document.getElementById('calorieTarget');
        const spinnerOverlay = document.getElementById('spinner-overlay');
        const alertPlaceholder = document.getElementById('alert-placeholder');
        
        // Time inputs
        const timeInputs = {
            breakfast: [document.getElementById('breakfastStart'), document.getElementById('breakfastEnd')],
            lunch: [document.getElementById('lunchStart'), document.getElementById('lunchEnd')],
            dinner: [document.getElementById('dinnerStart'), document.getElementById('dinnerEnd')]
        };

        // --- STATE MANAGEMENT ---
        let appState = {
            settings: {
                calorieTarget: 2000,
                mealTimes: {
                    breakfast: { start: '07:00', end: '10:00' },
                    lunch: { start: '12:00', end: '15:00' },
                    dinner: { start: '18:00', end: '21:00' }
                }
            },
            dailyLogs: {}
        };
        
        let analysisCache = []; // To hold the full nutrition data for logging

        // --- LIFECYCLE & INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            renderSettings();
            
            const today = new Date().toISOString().split('T')[0];
            if (!appState.dailyLogs[today]) {
                appState.dailyLogs[today] = [];
            }
            
            renderDashboard();

            if (!localStorage.getItem('totalfit_settings')) {
                new bootstrap.Modal(settingsModalEl).show();
            }

            setupEventListeners();
            autoSelectMealType();
        });

        // --- CORE FUNCTIONS ---

        /**
         * Loads state from localStorage.
         */
        function loadState() {
            const settings = localStorage.getItem('totalfit_settings');
            const logs = localStorage.getItem('totalfit_logs');
            if (settings) appState.settings = JSON.parse(settings);
            if (logs) appState.dailyLogs = JSON.parse(logs);
        }

        /**
         * Saves the current state to localStorage.
         */
        function saveState() {
            localStorage.setItem('totalfit_settings', JSON.stringify(appState.settings));
            localStorage.setItem('totalfit_logs', JSON.stringify(appState.dailyLogs));
        }
        
        /**
         * Populates the settings modal with current values.
         */
        function renderSettings() {
            calorieTargetInput.value = appState.settings.calorieTarget;
            timeInputs.breakfast[0].value = appState.settings.mealTimes.breakfast.start;
            timeInputs.breakfast[1].value = appState.settings.mealTimes.breakfast.end;
            timeInputs.lunch[0].value = appState.settings.mealTimes.lunch.start;
            timeInputs.lunch[1].value = appState.settings.mealTimes.lunch.end;
            timeInputs.dinner[0].value = appState.settings.mealTimes.dinner.start;
            timeInputs.dinner[1].value = appState.settings.mealTimes.dinner.end;
        }

        /**
         * Renders the entire dashboard (progress, logged meals).
         */
        function renderDashboard() {
            renderProgress();
            renderLoggedMeals();
        }
        
        /**
         * Updates the progress bar and text.
         */
        function renderProgress() {
            const today = new Date().toISOString().split('T')[0];
            const todayLogs = appState.dailyLogs[today] || [];
            const totalCalories = todayLogs.reduce((sum, meal) => sum + meal.totalCalories, 0);
            const target = appState.settings.calorieTarget;

            const percentage = Math.min((totalCalories / target) * 100, 100);
            
            progressBar.style.width = `${percentage}%`;
            progressBar.setAttribute('aria-valuenow', percentage);
            
            let barClass = 'bg-success';
            if (totalCalories > target * 0.9 && totalCalories <= target * 1.1) barClass = 'bg-warning';
            if (totalCalories > target * 1.1) barClass = 'bg-danger';
            progressBar.className = `progress-bar ${barClass}`;
            
            progressBarText.textContent = `${totalCalories} / ${target} kcal`;
            
            if (totalCalories < target) {
                 progressText.textContent = `${target - totalCalories} kcal remaining`;
            } else {
                 progressText.textContent = `${totalCalories - target} kcal over`;
            }
        }

        /**
         * Displays the list of logged meals for today.
         */
        function renderLoggedMeals() {
            const today = new Date().toISOString().split('T')[0];
            const todayLogs = appState.dailyLogs[today] || [];
            
            if (todayLogs.length === 0) {
                loggedMealsList.innerHTML = '<p class="text-muted">No meals logged yet today.</p>';
                return;
            }

            loggedMealsList.innerHTML = todayLogs.map((meal, index) => `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-${index}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${index}">
                            ${meal.mealType} - <strong>${meal.totalCalories} kcal</strong>
                        </button>
                    </h2>
                    <div id="collapse-${index}" class="accordion-collapse collapse" data-bs-parent="#logged-meals-list">
                        <div class="accordion-body">
                            <ul class="list-group list-group-flush">
                                ${meal.foods.map(food => `<li class="list-group-item d-flex justify-content-between"><span>${food.name} (${food.grams}g)</span> <span>${food.calories} kcal</span></li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        /**
         * Automatically selects the meal type based on the current time and user settings.
         */
        function autoSelectMealType() {
             const now = luxon.DateTime.local();
             const currentTime = now.toFormat('HH:mm');

             for (const [meal, times] of Object.entries(appState.settings.mealTimes)) {
                 if (currentTime >= times.start && currentTime <= times.end) {
                     mealTypeSelect.value = meal.charAt(0).toUpperCase() + meal.slice(1);
                     return;
                 }
             }
        }
        
         /**
         * Fetches data from the FatSecret proxy.
         */
        async function fetchFromFatSecret(method, params = {}) {
            const response = await fetch(`${PROXY_BASE_URL}/fatsecret`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fatsecret_method: method, ...params }),
            });
            if (!response.ok) {
                 const errorText = await response.text();
                 let errorMessage = errorText;
                 try {
                     // Try to parse the error as JSON to get a more specific message
                     const errorJson = JSON.parse(errorText);
                     errorMessage = errorJson.error?.message || errorJson.error || errorText;
                 } catch (e) {
                    // It's not JSON, so we'll use the raw text
                 }
                 throw new Error(`FatSecret API Error: ${errorMessage}`);
            }
            // The proxy now returns the full object from the API
            const data = await response.json();
            // The actual content is nested under a key like "foods" or "recipes"
            return data.foods || data.recipes || data.food || data;
        }

        /**
         * Updates the totals in the analysis table when grams are changed.
         */
        function updateAnalysisTotals() {
            let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;

            analysisCache.forEach((food, index) => {
                const gramsInput = document.getElementById(`grams-${index}`);
                const currentGrams = parseFloat(gramsInput.value) || 0;
                
                const ratio = currentGrams / 100;
                const calories = Math.round(food.calories * ratio);
                const protein = (food.protein * ratio).toFixed(1);
                const carbs = (food.carbs * ratio).toFixed(1);
                const fat = (food.fat * ratio).toFixed(1);
                
                document.getElementById(`calories-${index}`).textContent = calories;
                document.getElementById(`protein-${index}`).textContent = protein;
                document.getElementById(`carbs-${index}`).textContent = carbs;
                document.getElementById(`fat-${index}`).textContent = fat;
                
                totalCalories += calories;
                totalProtein += parseFloat(protein);
                totalCarbs += parseFloat(carbs);
                totalFat += parseFloat(fat);
            });
            
            document.getElementById('total-calories').textContent = Math.round(totalCalories);
            document.getElementById('total-protein').textContent = totalProtein.toFixed(1);
            document.getElementById('total-carbs').textContent = totalCarbs.toFixed(1);
            document.getElementById('total-fat').textContent = totalFat.toFixed(1);
        }
        
        /**
         * Fetches meal suggestions based on remaining calories.
         */
        async function getMealSuggestions() {
            const today = new Date().toISOString().split('T')[0];
            const todayLogs = appState.dailyLogs[today] || [];
            const totalCalories = todayLogs.reduce((sum, meal) => sum + meal.totalCalories, 0);
            const remaining = appState.settings.calorieTarget - totalCalories;

            if (remaining < 300) {
                suggestionsContainer.innerHTML = '<p class="text-muted">You are close to your goal. No suggestions at this time.</p>';
                return;
            }

            try {
                suggestionsContainer.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>';
                const data = await fetchFromFatSecret('recipes.search.v2', {
                    search_expression: 'healthy indian low calorie',
                    max_calories: Math.round(remaining / 2),
                    max_results: 3
                });

                if (!data || !data.recipe || data.recipe.length === 0) {
                    suggestionsContainer.innerHTML = '<p>Try some grilled veggies (200 kcal) or a fruit salad (150 kcal).</p>';
                    return;
                }

                const recipes = data.recipe;
                suggestionsContainer.innerHTML = recipes.map(recipe => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6 class="card-title">${recipe.recipe_name}</h6>
                            <p class="card-text small">${recipe.recipe_description}</p>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                 console.error("Suggestion Error:", error);
                 suggestionsContainer.innerHTML = '<p class="text-danger">Could not fetch suggestions.</p>';
            }
        }
        
        // --- EVENT HANDLERS ---
        function setupEventListeners() {
            imageUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                        analyzeBtn.disabled = false;
                    };
                    reader.readAsDataURL(file);
                }
            });

            analyzeBtn.addEventListener('click', async () => {
                const file = imageUpload.files[0];
                if (!file) {
                    showAlert('Please select an image first.', 'warning');
                    return;
                }
                
                showSpinner(true);
                analysisCache = [];

                try {
                    // 1. Call Clarifai via our proxy
                    const base64Image = imagePreview.src.split(',')[1];
                    
                    const clarifaiResponse = await fetch(`${PROXY_BASE_URL}/clarifai`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ base64Image })
                    });

                    if (!clarifaiResponse.ok) {
                        const errorData = await clarifaiResponse.json();
                        throw new Error(`Clarifai API request failed: ${errorData.error || 'Unknown error'}`);
                    }
                    
                    const clarifaiData = await clarifaiResponse.json();
                    const concepts = clarifaiData.outputs[0].data.concepts.filter(c => c.value > 0.7).slice(0, 5);
                    if(concepts.length === 0) {
                        showAlert('Could not identify any food in the image.', 'warning');
                        showSpinner(false);
                        return;
                    }

                    // 2. For each concept, get nutrition from FatSecret
                    const nutritionPromises = concepts.map(async (concept) => {
                        const searchData = await fetchFromFatSecret('foods.search.v2', { search_expression: concept.name, max_results: 1 });
                        if (!searchData || !searchData.food) return null;
                        
                        const foodId = searchData.food[0].food_id;
                        const nutritionDataWrapper = await fetchFromFatSecret('food.get.v2', { food_id: foodId });
                        if (!nutritionDataWrapper || !nutritionDataWrapper.food) return null;
                        
                        const nutritionData = nutritionDataWrapper.food;

                        const serving = nutritionData.servings.serving[0]; // Take the first serving size
                        const baseGrams = parseFloat(serving.metric_serving_amount) || 100;
                        const scale = 100 / baseGrams;
                        
                        return {
                            name: nutritionData.food_name,
                            grams: 150, // Default estimated grams
                            calories: Math.round(parseFloat(serving.calories) * scale),
                            protein: (parseFloat(serving.protein) * scale).toFixed(1),
                            carbs: (parseFloat(serving.carbohydrate) * scale).toFixed(1),
                            fat: (parseFloat(serving.fat) * scale).toFixed(1)
                        };
                    });

                    const results = (await Promise.all(nutritionPromises)).filter(Boolean);
                    analysisCache = results;

                    // 3. Render results table
                    if(results.length > 0) {
                        let tableHTML = `
                            <table class="table table-sm">
                                <thead><tr><th>Food</th><th>Grams</th><th>Cal</th><th>P</th><th>C</th><th>F</th></tr></thead>
                                <tbody>`;
                        results.forEach((food, index) => {
                            tableHTML += `
                                <tr>
                                    <td>${food.name}</td>
                                    <td><input type="number" class="form-control form-control-sm" id="grams-${index}" value="${food.grams}" style="width: 70px;"></td>
                                    <td id="calories-${index}">0</td>
                                    <td id="protein-${index}">0</td>
                                    <td id="carbs-${index}">0</td>
                                    <td id="fat-${index}">0</td>
                                </tr>
                            `;
                        });
                        tableHTML += `
                                </tbody>
                                <tfoot><tr class="fw-bold">
                                    <td>Total</td><td></td>
                                    <td id="total-calories">0</td>
                                    <td id="total-protein">0</td>
                                    <td id="total-carbs">0</td>
                                    <td id="total-fat">0</td>
                                </tr></tfoot>
                            </table>`;
                        analysisResultsTableContainer.innerHTML = tableHTML;
                        
                        // Add listeners to new inputs
                        results.forEach((_, index) => {
                           document.getElementById(`grams-${index}`).addEventListener('input', updateAnalysisTotals);
                        });
                        
                        updateAnalysisTotals(); // Initial calculation
                        stepUpload.style.display = 'none';
                        stepResults.style.display = 'block';
                    } else {
                        showAlert('Found food items, but could not get nutrition data.', 'warning');
                    }
                    
                } catch (error) {
                    console.error('Analysis Error:', error);
                    showAlert(`An error occurred: ${error.message}`, 'danger');
                } finally {
                    showSpinner(false);
                }
            });

            logMealBtn.addEventListener('click', () => {
                const today = new Date().toISOString().split('T')[0];
                const newMeal = {
                    mealType: mealTypeSelect.value,
                    totalCalories: Math.round(parseFloat(document.getElementById('total-calories').textContent)),
                    foods: []
                };

                analysisCache.forEach((_, index) => {
                    newMeal.foods.push({
                        name: analysisCache[index].name,
                        grams: parseFloat(document.getElementById(`grams-${index}`).value),
                        calories: parseFloat(document.getElementById(`calories-${index}`).textContent)
                    });
                });
                
                appState.dailyLogs[today].push(newMeal);
                saveState();
                renderDashboard();
                getMealSuggestions();
                showAlert('Meal logged successfully!', 'success');
                
                // Reset UI
                stepResults.style.display = 'none';
                analysisResultsTableContainer.innerHTML = '';
                imagePreview.style.display = 'none';
                imageUpload.value = '';
                analyzeBtn.disabled = true;
                stepUpload.style.display = 'block';
            });
            
            startOverBtn.addEventListener('click', () => {
                stepResults.style.display = 'none';
                analysisResultsTableContainer.innerHTML = '';
                imagePreview.style.display = 'none';
                imageUpload.value = '';
                analyzeBtn.disabled = true;
                stepUpload.style.display = 'block';
            });

            saveSettingsBtn.addEventListener('click', () => {
                appState.settings.calorieTarget = parseInt(calorieTargetInput.value) || 2000;
                appState.settings.mealTimes.breakfast.start = timeInputs.breakfast[0].value;
                appState.settings.mealTimes.breakfast.end = timeInputs.breakfast[1].value;
                appState.settings.mealTimes.lunch.start = timeInputs.lunch[0].value;
                appState.settings.mealTimes.lunch.end = timeInputs.lunch[1].value;
                appState.settings.mealTimes.dinner.start = timeInputs.dinner[0].value;
                appState.settings.mealTimes.dinner.end = timeInputs.dinner[1].value;
                
                saveState();
                renderDashboard();
                bootstrap.Modal.getInstance(settingsModalEl).hide();
                showAlert('Settings saved!', 'success');
            });
        }
        
        // --- UI UTILITIES ---

        function showSpinner(show) {
            spinnerOverlay.style.display = show ? 'flex' : 'none';
        }

        function showAlert(message, type = 'info') {
            const wrapper = document.createElement('div');
            wrapper.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            alertPlaceholder.append(wrapper);
            
            // Auto-dismiss
            setTimeout(() => {
                const alert = bootstrap.Alert.getOrCreateInstance(wrapper.querySelector('.alert'));
                if(alert) alert.close();
            }, 5000);
        }

    </script>
</body>
</html>